<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BATTLE RAP PT - Sistema de Avalia√ß√£o</title>
    <style>
        /* Estilos anteriores mantidos */
        .info-box {
            background-color: #f7e98d;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            max-width: 800px;
        }
        
        .rapper-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 20px;
        }

        .rapper-column {
            width: 23%;
            min-width: 300px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 15px;
            margin: 10px;
        }

        /* Restante do CSS mantido do exemplo anterior */
    </style>
</head>
<body>

<div class="info-box">
    <h2>üèÜ Sistema de Avalia√ß√£o de Batalhas üèÜ</h2>
    <p><strong>Como funciona:</strong></p>
    <ol>
        <li>Avalie cada rapper de 0-10 nos 6 crit√©rios</li>
        <li>Selecione o resultado de cada batalha</li>
        <li>Classifique se era Favorito ou Underdog</li>
        <li>Clique em Votar para calcular automaticamente</li>
    </ol>
    <p>üìä Pesos dos Crit√©rios:
        <br>Material (25%) | Confronto Direto (25%) | Advers√°rios (20%)
        <br>Consist√™ncia (10%) | Performance (10%) | Impacto (10%)
    </p>
</div>

<div class="rapper-container">
    <!-- 3ma -->
    <div class="rapper-column" id="rapper-3ma">
        <img src="https://via.placeholder.com/150" alt="3ma">
        <h2><a href="https://www.youtube.com/results?search_query=3ma" target="_blank">3ma</a></h2>
        
        <div class="input-group">
            <label>Material <input type="number" id="nota-material-3ma" min="0" max="10"></label>
            <label>Confronto <input type="number" id="nota-confronto-3ma" min="0" max="10"></label>
            <label>Advers√°rios <input type="number" id="nota-adversarios-3ma" min="0" max="10"></label>
            <label>Consist√™ncia <input type="number" id="nota-consistencia-3ma" min="0" max="10"></label>
            <label>Performance <input type="number" id="nota-performance-3ma" min="0" max="10"></label>
            <label>Impacto <input type="number" id="nota-impacto-3ma" min="0" max="10"></label>
        </div>

        <h3>‚öîÔ∏è Batalhas</h3>
        <div class="input-group">
            <label>VS KM:
                <select id="resultado-3ma-KM">
                    <option value="Venceu">Venceu</option>
                    <option value="Perdeu">Perdeu</option>
                    <option value="Empatou">Empatou</option>
                </select>
                <select id="favorito-3ma-KM">
                    <option value="Favorito">Favorito</option>
                    <option value="Underdog">Underdog</option>
                </select>
            </label>
        </div>
        
        <!-- Repetir para Shap3 e Lc -->
        
        <button class="button" data-rapper-id="3ma">Votar</button>
    </div>

    <!-- 7AM -->
    <div class="rapper-column" id="rapper-7AM">
        <!-- Estrutura similar com advers√°rio Riss -->
    </div>

    <!-- Abismal -->
    <div class="rapper-column" id="rapper-Abismal">
        <!-- Estrutura com Edi Ventura, RealPunch, WilsonG -->
    </div>

    <!-- AM -->
    <div class="rapper-column" id="rapper-AM">
        <!-- Estrutura com Licon, Melro, Vazto -->
    </div>

    <!-- AnimaNera -->
    <div class="rapper-column" id="rapper-AnimaNera">
        <!-- Estrutura com Slark, AM -->
    </div>
</div>

<!-- Tabela de resultados -->
<div class="table-container">
  <table class="results-table">
    <thead>
      <tr>
        <th>Rapper</th>
        <th>Pontua√ß√£o</th>
        <th>Vit√≥rias</th>
        <th>Derrotas</th>
        <th>Crit√©rio Mais Forte</th>
        <th>Tier</th>
      </tr>
    </thead>
    <tbody id="tabela-corpo">
      <tr>
        <td colspan="6">Aguardando votos...</td>
      </tr>
    </tbody>
  </table>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDJIo-2zIOeCRaXjQIo7OQAW3g-6aRdXeg",
    authDomain: "battlerappt.firebaseapp.com",
    projectId: "battlerappt",
    storageBucket: "battlerappt.firebasestorage.app",
    messagingSenderId: "291516729501",
    appId: "1:291516729501:web:3d945fc3155d1695356c74",
    measurementId: "G-6KBBCB9RFB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Lista completa de rappers com advers√°rios
  const rappers = [
    { id: '3ma', nome: '3ma', adversarios: ['KM', 'Shap3', 'Lc'] },
    { id: '7AM', nome: '7AM', adversarios: ['Riss'] },
    { id: 'MAX', nome: 'MAX', adversarios: ['Zolty', 'MK'] },
    // Adicione todos os outros rappers seguindo o mesmo padr√£o...
  ];

  // Fun√ß√£o para gerar dinamicamente as colunas dos rappers
  function criarColunasRappers() {
    const container = document.querySelector('.rapper-container');
    
    rappers.forEach(rapper => {
      const column = document.createElement('div');
      column.className = 'rapper-column';
      column.id = `rapper-${rapper.id}`;
      
      column.innerHTML = `
        <img src="https://via.placeholder.com/150" alt="${rapper.nome}">
        <h2><a href="https://www.youtube.com/results?search_query=${rapper.nome}" target="_blank">${rapper.nome}</a></h2>
        <h3>Avalia√ß√£o do rapper</h3>
        ${gerarInputsNotas(rapper.id)}
        <h3>Batalhas</h3>
        ${gerarBatalhas(rapper)}
        <button class="button" onclick="votar('${rapper.id}')">Votar</button>
      `;
      
      container.appendChild(column);
    });
  }

  function gerarInputsNotas(rapperId) {
    const criterios = [
      { id: 'material', label: 'Material (0-10):' },
      { id: 'confronto', label: 'Confronto Direto (0-10):' },
      { id: 'adversarios', label: 'Advers√°rios (0-10):' },
      { id: 'consistencia', label: 'Consist√™ncia (0-10):' },
      { id: 'performance', label: 'Performance (0-10):' },
      { id: 'impacto', label: 'Impacto (0-10):' }
    ];

    return criterios.map(c => `
      <div class="input-group">
        <label for="nota-${c.id}-${rapperId}">${c.label}</label>
        <input type="number" id="nota-${c.id}-${rapperId}" min="0" max="10">
      </div>
    `).join('');
  }

  function gerarBatalhas(rapper) {
    return rapper.adversarios.map(adversario => `
      <div class="input-group">
        <label>${rapper.nome} VS ${adversario}</label>
        <select id="resultado-${rapper.id}-${adversario}">
          <option value="Venceu">Venceu</option>
          <option value="Perdeu">Perdeu</option>
          <option value="Empatou">Empatou</option>
        </select>
        <select id="favorito-${rapper.id}-${adversario}">
          <option value="Favorito">Favorito</option>
          <option value="Underdog">Underdog</option>
        </select>
        <a class="assistir-link" href="https://www.youtube.com/results?search_query=${rapper.nome}+VS+${adversario}" target="_blank">Assistir</a>
      </div>
    `).join('');
  }

  async function votar(rapperId) {
    const rapper = rappers.find(r => r.id === rapperId);
    
    // Coletar notas
    const notas = {
      material: parseFloat(document.getElementById(`nota-material-${rapperId}`).value) || 0,
      confronto: parseFloat(document.getElementById(`nota-confronto-${rapperId}`).value) || 0,
      adversarios: parseFloat(document.getElementById(`nota-adversarios-${rapperId}`).value) || 0,
      consistencia: parseFloat(document.getElementById(`nota-consistencia-${rapperId}`).value) || 0,
      performance: parseFloat(document.getElementById(`nota-performance-${rapperId}`).value) || 0,
      impacto: parseFloat(document.getElementById(`nota-impacto-${rapperId}`).value) || 0
    };

    // Validar notas
    if (Object.values(notas).some(nota => nota < 0 || nota > 10)) {
      alert('Por favor, insira notas entre 0 e 10!');
      return;
    }

    // Coletar batalhas e calcular resultados
    const batalhas = {};
    let vitorias = 0, derrotas = 0;
    
    rapper.adversarios.forEach(adversario => {
      const resultado = document.getElementById(`resultado-${rapperId}-${adversario}`).value;
      const status = document.getElementById(`favorito-${rapperId}-${adversario}`).value;
      
      batalhas[adversario] = { resultado, status };
      
      if (resultado === 'Venceu') vitorias++;
      if (resultado === 'Perdeu') derrotas++;
    });

    // Calcular pontua√ß√£o
    const pesos = { material: 0.25, confronto: 0.25, adversarios: 0.20, consistencia: 0.10, performance: 0.10, impacto: 0.10 };
    let pontuacao = Object.entries(notas).reduce((acc, [key, value]) => acc + (value * pesos[key]), 0);

    // Aplicar modificadores de batalha
    Object.values(batalhas).forEach(({ resultado, status }) => {
      if (resultado === 'Venceu' && status === 'Underdog') pontuacao *= 1.20;
      if (resultado === 'Perdeu' && status === 'Favorito') pontuacao *= 0.80;
    });

    // Salvar no Firestore
    try {
      await setDoc(doc(db, "votos", `${rapperId}_${Date.now()}`), {
        rapperId,
        pontuacao: parseFloat(pontuacao.toFixed(2)),
        vitorias,
        derrotas,
        timestamp: new Date()
      });
      alert('Voto registrado com sucesso!');
    } catch (error) {
      console.error("Erro ao salvar voto:", error);
      alert('Erro ao registrar voto!');
    }
  }

  function observarVotos() {
    onSnapshot(collection(db, "votos"), (snapshot) => {
      const resultados = {};

      snapshot.docs.forEach(doc => {
        const data = doc.data();
        if (!resultados[data.rapperId]) {
          resultados[data.rapperId] = {
            totalPontos: 0,
            totalVotos: 0,
            totalVitorias: 0,
            totalDerrotas: 0
          };
        }

        resultados[data.rapperId].totalPontos += data.pontuacao;
        resultados[data.rapperId].totalVotos++;
        resultados[data.rapperId].totalVitorias += data.vitorias;
        resultados[data.rapperId].totalDerrotas += data.derrotas;
      });

      atualizarTabela(resultados);
    });
  }

  function atualizarTabela(resultados) {
    const tbody = document.getElementById('tabela-corpo');
    tbody.innerHTML = '';

    rappers.forEach(rapper => {
      const dados = resultados[rapper.id] || { totalPontos: 0, totalVotos: 1 };
      const media = dados.totalPontos / (dados.totalVotos || 1);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${rapper.nome}</td>
        <td>${media.toFixed(2)}</td>
        <td>${dados.totalVitorias}</td>
        <td>${dados.totalDerrotas}</td>
        <td>Material</td>
        <td>${media > 8 ? 'S' : media > 6 ? 'A' : 'B'}</td>
      `;
      tbody.appendChild(row);
    });
  }

  window.onload = function() {
    criarColunasRappers();
    observarVotos();
  };
</script>
</body>
</html>
